import React, { useState, useRef, useEffect } from 'react';
import { Box, Paper, IconButton, TextField, Stack, Typography } from '@mui/material';
import RefreshIcon from '@mui/icons-material/Refresh';
import ArrowBackIcon from '@mui/icons-material/ArrowBack';
import ArrowForwardIcon from '@mui/icons-material/ArrowForward';
import { ClaudeShellPanel } from '../components/ClaudeShellPanel';

declare global {
  interface Window {
    browserAPI: {
      onLoadUrl: (callback: (url: string) => void) => void;
      onSetShellId: (callback: (shellId: string) => void) => void;
      onSetWebviewPreload: (callback: (preloadPath: string) => void) => void;
      removeAllListeners: (channel: string) => void;
      claudeShellWrite: (shellId: string, input: string) => Promise<{ success: boolean }>;
      claudeShellResize: (shellId: string, cols: number, rows: number) => Promise<{ success: boolean }>;
      onClaudeShellOutput: (callback: (shellId: string, output: string) => void) => void;
      onClaudeShellError: (callback: (shellId: string, error: string) => void) => void;
      onClaudeShellExit: (callback: (shellId: string, code: number | null, signal: string | null) => void) => void;
    };
  }
}

export const BrowserPage: React.FC = () => {
  const [url, setUrl] = useState('');
  const [shellId, setShellId] = useState<string | null>(null);
  const [webviewPreloadPath, setWebviewPreloadPath] = useState<string>('');
  const webviewRef = useRef<any>(null);
  const [webviewElement, setWebviewElement] = useState<any>(null);
  const [canGoBack, setCanGoBack] = useState(false);
  const [canGoForward, setCanGoForward] = useState(false);
  const [webviewReady, setWebviewReady] = useState(false);
  const [pendingUrl, setPendingUrl] = useState<string | null>(null);

  // Listen for URL to load
  useEffect(() => {
    const handleLoadUrl = (targetUrl: string) => {
      console.log('[BrowserPage] Received URL to load:', targetUrl, 'webviewReady:', webviewReady);

      if (webviewReady && webviewRef.current) {
        console.log('[BrowserPage] Webview is ready, loading URL immediately');
        setUrl(targetUrl);
        webviewRef.current.loadURL(targetUrl);
      } else {
        console.log('[BrowserPage] Webview not ready yet, storing URL for later');
        setPendingUrl(targetUrl);
      }
    };

    window.browserAPI.onLoadUrl(handleLoadUrl);

    return () => {
      window.browserAPI.removeAllListeners('load-url');
    };
  }, [webviewReady]);

  // Listen for shell ID
  useEffect(() => {
    const handleSetShellId = (id: string) => {
      console.log('[BrowserPage] Received shell ID:', id);
      setShellId(id);
    };

    window.browserAPI.onSetShellId(handleSetShellId);

    return () => {
      window.browserAPI.removeAllListeners('set-shell-id');
    };
  }, []);

  // Listen for webview preload path
  useEffect(() => {
    const handleSetWebviewPreload = (preloadPath: string) => {
      console.log('[BrowserPage] Received webview preload path:', preloadPath);
      setWebviewPreloadPath(preloadPath);
    };

    window.browserAPI.onSetWebviewPreload(handleSetWebviewPreload);

    return () => {
      window.browserAPI.removeAllListeners('set-webview-preload');
    };
  }, []);

  // Try to load URL when webview becomes ready
  useEffect(() => {
    if (webviewReady && pendingUrl && webviewRef.current) {
      console.log('[BrowserPage] Webview is now ready, loading pending URL:', pendingUrl);
      setUrl(pendingUrl);
      webviewRef.current.loadURL(pendingUrl);
      setPendingUrl(null);
    }
  }, [webviewReady, pendingUrl]);

  // Handle webview ref callback
  const handleWebviewRef = (element: any) => {
    webviewRef.current = element;
    setWebviewElement(element);

    if (element) {
      console.log('[BrowserPage] Webview element attached to DOM');
    }
  };

  // Setup webview event listeners
  useEffect(() => {
    if (!webviewElement || !webviewPreloadPath) return;

    const webview = webviewElement;

    const handleDomReady = () => {
      console.log('[BrowserPage] Webview DOM ready');
      setWebviewReady(true);

      // Load pending URL if exists
      if (pendingUrl) {
        console.log('[BrowserPage] Loading pending URL:', pendingUrl);
        setUrl(pendingUrl);
        webview.loadURL(pendingUrl);
        setPendingUrl(null);
      }
    };

    const handleDidNavigate = (e: any) => {
      console.log('[BrowserPage] Webview did navigate:', e.url);
      setUrl(e.url);
      setCanGoBack(webview.canGoBack());
      setCanGoForward(webview.canGoForward());
    };

    const handleDidStartLoading = () => {
      console.log('[BrowserPage] Webview started loading');
    };

    const handleDidStopLoading = () => {
      console.log('[BrowserPage] Webview stopped loading');
    };

    // Add event listeners
    webview.addEventListener('dom-ready', handleDomReady);
    webview.addEventListener('did-navigate', handleDidNavigate);
    webview.addEventListener('did-navigate-in-page', handleDidNavigate);
    webview.addEventListener('did-start-loading', handleDidStartLoading);
    webview.addEventListener('did-stop-loading', handleDidStopLoading);

    return () => {
      webview.removeEventListener('dom-ready', handleDomReady);
      webview.removeEventListener('did-navigate', handleDidNavigate);
      webview.removeEventListener('did-navigate-in-page', handleDidNavigate);
      webview.removeEventListener('did-start-loading', handleDidStartLoading);
      webview.removeEventListener('did-stop-loading', handleDidStopLoading);
    };
  }, [webviewElement, webviewPreloadPath, pendingUrl]);

  const handleBack = () => {
    if (webviewRef.current && canGoBack) {
      webviewRef.current.goBack();
    }
  };

  const handleForward = () => {
    if (webviewRef.current && canGoForward) {
      webviewRef.current.goForward();
    }
  };

  const handleRefresh = () => {
    if (webviewRef.current && webviewReady) {
      webviewRef.current.reload();
    }
  };

  const handleUrlChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setUrl(e.target.value);
  };

  const handleUrlSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (webviewRef.current && webviewReady && url) {
      let finalUrl = url;
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        finalUrl = 'https://' + url;
      }
      webviewRef.current.loadURL(finalUrl);
    }
  };

  return (
    <Box sx={{ display: 'flex', height: '100vh', flexDirection: 'column' }}>
      {/* Navigation Bar */}
      <Paper sx={{ p: 1 }}>
        <Stack direction="row" spacing={1} alignItems="center">
          <IconButton onClick={handleBack} disabled={!canGoBack} size="small">
            <ArrowBackIcon />
          </IconButton>
          <IconButton onClick={handleForward} disabled={!canGoForward} size="small">
            <ArrowForwardIcon />
          </IconButton>
          <IconButton onClick={handleRefresh} size="small" disabled={!webviewReady}>
            <RefreshIcon />
          </IconButton>
          <Box component="form" onSubmit={handleUrlSubmit} sx={{ flex: 1 }}>
            <TextField
              fullWidth
              size="small"
              value={url}
              onChange={handleUrlChange}
              placeholder="Enter URL"
            />
          </Box>
        </Stack>
      </Paper>

      {/* Main content area with webview and terminal */}
      <Box sx={{ display: 'flex', flex: 1, overflow: 'hidden' }}>
        {/* Webview container */}
        <Box sx={{ flex: 1, position: 'relative', overflow: 'hidden' }}>
          {webviewPreloadPath ? (
            <webview
              ref={handleWebviewRef}
              style={{
                width: '100%',
                height: '100%',
                border: 'none',
              }}
              preload={webviewPreloadPath}
              src="about:blank"
              partition="persist:windev"
            />
          ) : (
            <Box
              sx={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                width: '100%',
                height: '100%',
              }}
            >
              <Typography variant="body2" color="text.secondary">
                Initializing webview...
              </Typography>
            </Box>
          )}
        </Box>

        {/* Claude terminal panel */}
        {shellId ? (
          <Box sx={{ width: 475, height: '100%', borderLeft: '1px solid #333' }}>
            <ClaudeShellPanel shellId={shellId} />
          </Box>
        ) : (
          <Box sx={{ width: 475, borderLeft: '1px solid #333', bgcolor: '#1e1e1e', p: 2 }}>
            <Paper sx={{ p: 2 }}>
              <Stack spacing={2}>
                <Typography variant="body2" color="text.secondary">
                  No Claude Code terminal available
                </Typography>
                <Typography variant="caption" color="text.secondary">
                  To enable the Claude Code terminal, configure a repository path for this service in the main window.
                </Typography>
              </Stack>
            </Paper>
          </Box>
        )}
      </Box>
    </Box>
  );
};
